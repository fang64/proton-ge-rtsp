From 652e28fca35e9e51d7e8c63b66342d874aa4a382 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Fri, 16 Aug 2024 02:29:05 +0200
Subject: [PATCH 38/53] mfmediaengine: Unstub IMFMediaEngine::SetAutoPlay.

CW-Bug-Id: #21644
---
 dlls/mfmediaengine/main.c | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/dlls/mfmediaengine/main.c b/dlls/mfmediaengine/main.c
index cd68c122851..a0d041c35db 100644
--- a/dlls/mfmediaengine/main.c
+++ b/dlls/mfmediaengine/main.c
@@ -1407,7 +1407,7 @@ static HRESULT WINAPI media_engine_load_handler_Invoke(IMFAsyncCallback *iface,
     engine->network_state = MF_MEDIA_ENGINE_NETWORK_LOADING;
     IMFMediaEngineNotify_EventNotify(engine->callback, MF_MEDIA_ENGINE_EVENT_LOADSTART, 0, 0);
 
-    start_playback = engine->flags & FLAGS_ENGINE_PLAY_PENDING;
+    start_playback = (engine->flags & FLAGS_ENGINE_PLAY_PENDING) || (engine->flags & FLAGS_ENGINE_AUTO_PLAY);
     media_engine_set_flag(engine, FLAGS_ENGINE_SOURCE_PENDING | FLAGS_ENGINE_PLAY_PENDING, FALSE);
 
     if (SUCCEEDED(IMFAsyncResult_GetState(result, &state)))
@@ -2023,14 +2023,19 @@ static BOOL WINAPI media_engine_GetAutoPlay(IMFMediaEngineEx *iface)
 static HRESULT WINAPI media_engine_SetAutoPlay(IMFMediaEngineEx *iface, BOOL autoplay)
 {
     struct media_engine *engine = impl_from_IMFMediaEngineEx(iface);
+    HRESULT hr = S_OK;
 
-    FIXME("(%p, %d): stub.\n", iface, autoplay);
+    TRACE("%p, %d.\n", iface, autoplay);
 
     EnterCriticalSection(&engine->cs);
-    media_engine_set_flag(engine, FLAGS_ENGINE_AUTO_PLAY, autoplay);
+    if (autoplay && !(engine->flags & FLAGS_ENGINE_SHUT_DOWN) &&
+        engine->network_state == MF_MEDIA_ENGINE_NETWORK_IDLE)
+        hr = IMFMediaEngineEx_Play(iface);
+    if (SUCCEEDED(hr))
+        media_engine_set_flag(engine, FLAGS_ENGINE_AUTO_PLAY, autoplay);
     LeaveCriticalSection(&engine->cs);
 
-    return S_OK;
+    return hr;
 }
 
 static BOOL WINAPI media_engine_GetLoop(IMFMediaEngineEx *iface)
-- 
2.47.1

