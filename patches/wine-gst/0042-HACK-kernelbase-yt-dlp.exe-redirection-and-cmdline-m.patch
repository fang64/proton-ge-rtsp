From 152841cbdd14102620529a7accbc02bfec9731b5 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Thu, 28 Mar 2024 16:43:07 +0100
Subject: [PATCH 42/46] [HACK] kernelbase: yt-dlp.exe redirection and cmdline
 modification to read cookies from browser.

---
 dlls/kernelbase/process.c | 51 +++++++++++++++++++++++++++++++++++++++
 1 file changed, 51 insertions(+)

diff --git a/dlls/kernelbase/process.c b/dlls/kernelbase/process.c
index 387ae09bc11..f716d0bf35f 100644
--- a/dlls/kernelbase/process.c
+++ b/dlls/kernelbase/process.c
@@ -584,6 +584,54 @@ static int battleye_launcher_redirect_hack( const WCHAR *app_name, WCHAR *new_na
     return 1;
 }
 
+static int ytdlp_hack( const WCHAR *app_name, WCHAR *new_name, DWORD new_name_len, WCHAR **cmdline )
+{
+    static const WCHAR ytdlp_exeW[] = L"yt-dlp.exe";
+    static const size_t ytdlp_exeW_len = ARRAY_SIZE(ytdlp_exeW) - 1;
+    static const WCHAR cookiesfrombrowserW[] = L" --cookies-from-browser ";
+    static const size_t cookiesfrombrowserW_len = ARRAY_SIZE(cookiesfrombrowserW) - 1;
+
+    WCHAR ytdlp_path[MAX_PATH], browser[32 + MAX_PATH];
+    WCHAR *new_cmdline = NULL;
+    size_t len;
+
+    if (!app_name || !*cmdline)
+        return 0;
+
+    len = wcslen( app_name );
+    if (len < ytdlp_exeW_len + 1)
+        return 0;
+    if (app_name[len - ytdlp_exeW_len - 1] != '\\' && app_name[len - ytdlp_exeW_len - 1] != '/')
+        return 0;
+    if (wcscmp( app_name + (len - ytdlp_exeW_len), ytdlp_exeW ))
+        return 0;
+
+    ytdlp_path[0] = 0;
+    GetEnvironmentVariableW(L"PROTON_YTDLP_PATH", ytdlp_path, ARRAY_SIZE(ytdlp_path));
+    if (wcslen( ytdlp_path ) >= new_name_len)
+        return 0;
+
+    browser[0] = 0;
+    GetEnvironmentVariableW(L"PROTON_YTDLP_BROWSER", browser, ARRAY_SIZE(browser));
+    if (browser[0])
+    {
+        if (!(new_cmdline = RtlAllocateHeap( GetProcessHeap(), 0, (wcslen( *cmdline ) + cookiesfrombrowserW_len + wcslen( browser ) + 1) * sizeof(WCHAR) )))
+            return 0;
+    }
+
+    if (ytdlp_path[0])
+        wcscpy( new_name, ytdlp_path );
+    if (browser[0] && new_cmdline)
+    {
+        wcscpy( new_cmdline, *cmdline );
+        wcscat( new_cmdline, cookiesfrombrowserW );
+        wcscat( new_cmdline, browser );
+        HeapFree( GetProcessHeap(), 0, *cmdline );
+        *cmdline = new_cmdline;
+    }
+    return ytdlp_path[0];
+}
+
 static const WCHAR *hack_append_command_line( const WCHAR *cmd )
 {
     static const struct
@@ -713,6 +761,9 @@ BOOL WINAPI DECLSPEC_HOTPATCH CreateProcessInternalW( HANDLE token, const WCHAR
     if (battleye_launcher_redirect_hack( app_name, name, ARRAY_SIZE(name), &orig_app_name ))
         app_name = name;
 
+    if (ytdlp_hack( app_name, name, ARRAY_SIZE(name), &tidy_cmdline ))
+        app_name = name;
+
     /* Warn if unsupported features are used */
 
     if (flags & (IDLE_PRIORITY_CLASS | HIGH_PRIORITY_CLASS | REALTIME_PRIORITY_CLASS |
-- 
2.46.0

