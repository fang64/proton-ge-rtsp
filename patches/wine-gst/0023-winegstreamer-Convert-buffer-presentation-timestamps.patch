From 6d0bfd1a5883ccc81ceea1bd467ea5c9e10cb112 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Wed, 31 Jan 2024 17:42:55 +0100
Subject: [PATCH 23/43] winegstreamer: Convert buffer presentation timestamps
 into running time.

---
 dlls/winegstreamer/wg_parser.c | 46 +++++++++++++++++++++++-----------
 1 file changed, 31 insertions(+), 15 deletions(-)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 3eb4134b931..e6170b96cb9 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -306,6 +306,18 @@ static GstBuffer *wait_parser_stream_buffer(struct wg_parser *parser, struct wg_
     return buffer;
 }
 
+static void release_buffer(struct wg_parser *parser, struct wg_parser_stream *stream)
+{
+    if (stream->buffer)
+    {
+        gst_buffer_unmap(stream->buffer, &stream->map_info);
+        gst_buffer_unref(stream->buffer);
+        stream->buffer = NULL;
+    }
+
+    pthread_cond_signal(&stream->event_empty_cond);
+}
+
 static NTSTATUS wg_parser_stream_get_buffer(void *args)
 {
     const struct wg_parser_stream_get_buffer_params *params = args;
@@ -317,6 +329,7 @@ static NTSTATUS wg_parser_stream_get_buffer(void *args)
 
     pthread_mutex_lock(&parser->mutex);
 
+retry:
     if (stream)
         buffer = wait_parser_stream_buffer(parser, stream);
     else
@@ -359,13 +372,24 @@ static NTSTATUS wg_parser_stream_get_buffer(void *args)
         return S_FALSE;
     }
 
-    /* FIXME: Should we use gst_segment_to_stream_time_full()? Under what
-     * circumstances is the stream time not equal to the buffer PTS? Note
-     * that this will need modification to wg_parser_stream_notify_qos() as
-     * well. */
-
     if ((wg_buffer->has_pts = GST_BUFFER_PTS_IS_VALID(buffer)))
-        wg_buffer->pts = GST_BUFFER_PTS(buffer) / 100;
+    {
+        if (stream->segment.format != GST_FORMAT_TIME)
+        {
+            /* Some types of streams (e.g. HLS) don't provide a segment. Assume that these start their PTS at zero. */
+            wg_buffer->pts = GST_BUFFER_PTS(buffer) / 100;
+        }
+        else
+        {
+            guint64 stream_time = gst_segment_to_running_time(&stream->segment, GST_FORMAT_TIME, GST_BUFFER_PTS(buffer));
+            if (stream_time == -1)
+            {
+                release_buffer(parser, stream);
+                goto retry;
+            }
+            wg_buffer->pts = stream_time / 100;
+        }
+    }
     if ((wg_buffer->has_duration = GST_BUFFER_DURATION_IS_VALID(buffer)))
         wg_buffer->duration = GST_BUFFER_DURATION(buffer) / 100;
     wg_buffer->discontinuity = GST_BUFFER_FLAG_IS_SET(buffer, GST_BUFFER_FLAG_DISCONT);
@@ -408,16 +432,8 @@ static NTSTATUS wg_parser_stream_release_buffer(void *args)
     struct wg_parser *parser = stream->parser;
 
     pthread_mutex_lock(&parser->mutex);
-
-    if (stream->buffer)
-    {
-        gst_buffer_unmap(stream->buffer, &stream->map_info);
-        gst_buffer_unref(stream->buffer);
-        stream->buffer = NULL;
-    }
-
+    release_buffer(parser, stream);
     pthread_mutex_unlock(&parser->mutex);
-    pthread_cond_signal(&stream->event_empty_cond);
 
     return S_OK;
 }
-- 
2.45.2

